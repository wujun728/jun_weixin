实战
微信公众平台开发最佳实践

方倍工作室 著






图书在版编目（CIP）数据
微信公众平台开发最佳实践/方倍工作室著. ―北京：机械工业出版社，2014.4
（实战）
ISBN 978-7-111-46332-0
I. 微…　II.方…　III. 移动电话机C程序开发工具　IV. TN929.53
中国版本图书馆CIP数据核字（2014）第062039号

    本书共分10章，案例程序采用广泛流行的PHP、MySQL、XML、CSS、JavaScript、HTML5等程序语言及数据库实现。系统完整地介绍微信公众平台基础接口、自定义菜单、高级接口、微信支付、分享转发等所有相关技术，以生活类、娱乐类、企业类微信开发为切入点，讲解了30多个功能或应用案例。
    本书按照从简单到复杂，从基础到实践的方式编排，在讲解过程中注重将原理和实践相结合。初学者可以在了解PHP和MySQL语法之后，从头至尾学习，对于其中难以理解的部分可以查阅相关资料，针对企业功能类的开发还需要具有一定的JavaScript、CSS、HTML等编程基础。
    本书可以作为微信公众平台开发的教程。对于移动互联网及微信公众平台的相关从业人员，本书也具有极大的参考价值。





微信公众平台开发最佳实践
方倍工作室　著
出版发行：机械工业出版社（北京市西城区百万庄大街22号　邮政编码：100037）
责任编辑：秦　健	
印　　刷：	版　　次：2014年4月第1版第1次印刷
开　　本：170mm×242mm　1/16	印　　张：20.5
书　　号：ISBN 978-7-111-46332-0	定　　价：69.00元
凡购本书，如有缺页、倒页、脱页，由本社发行部调换
客服热线：（010）88378991　88361066	投稿热线：（010）88379604
购书热线：（010）68326294　88379649　68995259	读者信箱：hzjsj@hzbook.com
版权所有・侵权必究
封底无防伪标均为盗版
本书法律顾问：北京大成律师事务所　韩光/邹晓东





前　　言
出版说明
方倍工作室自从在博客园推出微信公众平台开发系列教程后，受到广大微信开发人员及爱好者的热情关注，相关文章的日访问量高达上万人次，而“微信公众平台开发入门教程”的阅读量早已超出10万，很多博文被多家有影响力的网站转载，并被各大搜索引擎收录且排名靠前，这些是我们始料未及的。
然而更让我们感到高兴的是，很多开发者通过学习我们的教程学会了微信公众平台开发，并且通过微信开发获得收益。2013年10月17日，我们在QQ空间发布了新版的《微信公众平台开发入门教程》链接后，网友“我叫不熬夜?”在空间中回复，他之前通过学习我们的微信开发教程赚到了2000元钱，而他目前还只是一名学生。这条回复记录至今还保存在方倍工作室的QQ空间中，这给了我们不断向前的动力。
为了推出更好、更有价值的作品，在易伟律师的推荐及机械工业出版社王彬编辑的支持下，我们整合已有的教程资源并从2013年的100多个开发案例中挑选出最受欢迎的应用功能，形成了本书。本书全面介绍微信公众平台（包括微信支付在内）的所有接口及使用方法，并辅以30多个功能应用案例及技巧，同时在分析过程中融合相关知识与技术，力求使读者不但“知其然”，而且“知其所以然”，希期为读者奉献一本含金量高的书籍。
读者对象
本书适合以下人群阅读：
想了解移动互联网及微信公众平台发展的行业从业人员。
想了解微信公众平台产品使用方法、技巧及效果评估的微信营销人员。
想提高会员活跃度、提高指标转化率、推进品牌推广的公众平台运营人员。
想学习微信公众平台开发的入门、初级、中级、高级开发人员。
想使用微信公众平台兼职开发、创业等渴望更成功的人员。
想搭建企业内部强大及实用的微信公众平台的开发团队。
阅读指南
本书分为10章。
第1章简要介绍了微信及其两大平台：微信公众平台与微信开放平台，重点介绍了微信公众平台后台的各项功能。
第2章介绍了申请服务器资源的方法，包括申请新浪云及购买虚拟空间两种方式。拥有服务器资源是进行微信公众平台开发的前提。
第3章介绍了如何启用微信公众平台的开发模式，以及启用过程中常见问题的解决方式，最后分析了微信公众平台自动回复的原理。读者需要理解开发模式的原理，这是进行后续开发的基础。
第4章介绍了微信公众平台基础接口的3个部分，包括接收用户发送的6种消息、以6种方式向用户回复消息、接收关注及取消关注的事件推送消息，所有消息类型都给出了实现方法。这些消息类型是微信公众平台与用户交互的基础
功能。
第5章介绍了自定义菜单与高级接口的9大功能。这些功能都需要向微信公众平台额外申请权限，它们使得微信交互不再限于消息交互，而是能达到更广、更深的层次。基于这些接口的功能将是今后微信开发的趋势，本书对这些功能做了详细介绍并列出了实现代码。
第6章详细介绍了微信支付的申请流程及功能介绍，并且对微信支付中的两种主要支付方式的实现原理进行了深入剖析，另外还讲解了商户功能的其他相关接口的内容。
第7章介绍了10个生活类应用的开发。本书对这些应用从接口申请、数据获取直到开发实现、案例截图都做了详细描述，读者掌握这些应用的开发后可以丰富自己公众账号的功能。
第8章介绍了8个娱乐类应用的开发。这些应用都是非常受用户欢迎的，读者学完后可以快速移植到自己的微信公众平台，提高粉丝互动的价值。
第9章介绍了企业最常用功能的开发实现，其中还包括部分高级接口在企业应用的实现，这些功能为企业开发提供了方向及技术指导。
第10章介绍了微信开发的其他相关实用技巧，这些小技巧能为公众账号带来更加有趣的体验。
本书程序案例采用广泛流行的PHP、MySQL、XML、CSS、JavaScript、HTML5等程序语言及数据库实现，所有案例均在书中给出了核心实现代码。初学者可以在了解PHP和MySQL语法之后，从头至尾学习，对于其中难以理解的部分可以查阅相关资料，针对企业功能类的开发还需要具有一定的JavaScript、CSS等基础。有经验的微信公众平台开发人员可以根据自己需要，直接切入相应章节。其他从业人员则可以选择自己感兴趣的内容阅读。
由于作者水平及能力有限，加之时间仓促，书中难免出现错误和不妥之处，对于一些依赖第三方功能的实现也可能由于外部原因难以保证可以永久使用，恳请读者批评指正！
致谢
首先感谢“微信之父”张小龙先生及微信团队，是他们创造了微信这一经典传世之作。
感谢易伟律师的推荐及机械工作出版社王彬编辑的支持，是他们促成了这本书的出版。
感谢我最亲爱的家人在背后的默默支持与付出。
本书成书过程中也得到了诸多同行的支持与鼓励，在此一并致谢。
谨以此书献给所有热爱移动互联网和微信及微信公众平台的人们。

方倍
2014年3月于深圳



目　　录
前　言
第1章　微信公众平台介绍  1
1.1　微信及其两大平台  1
1.2　微信公众平台  2
1.2.1　功能  2
1.2.2　管理  5
1.2.3　服务  6
1.2.4　统计  7
1.2.5　设置  9
第2章　获取服务器资源  11
2.1　新浪SAE  11
2.1.1　申请账号  11
2.1.2　创建应用  13
2.1.3　创建版本  14
2.1.4　上传代码  15
2.2　虚拟主机  18
第3章　开发模式  21
3.1　启用开发模式  21
3.1.1　关闭编辑模式  21
3.1.2　启用开发模式  22
3.1.3　常见问题与解决方案  23
3.2　实现自动回复  24
3.3　消息交互原理分析  24
第4章　基础接口  28
4.1　接收用户消息  28
4.1.1　接收文本消息  28
4.1.2　接收图片消息  28
4.1.3　接收语音消息  29
4.1.4　接收视频消息  30
4.1.5　接收地理位置消息  30
4.1.6　接收链接消息  31
4.1.7　代码实现  32
4.2　向用户回复消息  35
4.2.1　文本消息  35
4.2.2　图片消息  36
4.2.3　语音消息  37
4.2.4　视频消息  37
4.2.5　音乐消息  38
4.2.6　图文消息  39
4.2.7　代码实现  42
4.3　接收事件推送消息  48
4.3.1　关注/取消关注  48
4.3.2　代码实现  49
第5章　自定义菜单和高级接口  52
5.1　Access Token  52
5.1.1　Access Token  52
5.1.2　接口调用请求说明  52
5.1.3　实现代码  53
5.2　自定义菜单  53
5.2.1　自定义菜单介绍  54
5.2.2　按钮类型  54
5.2.3　创建菜单  54
5.2.4　查询菜单  57
5.2.5　删除菜单  58
5.2.6　菜单事件推送  58
5.3　语音识别  60
5.3.1　接收识别结果  60
5.3.2　处理识别消息  61
5.4　客服接口  61
5.4.1　客服接口实现  62
5.4.2　消息接口与客服接口相结合  70
5.4.3　客服接口的意义  71
5.5　OAuth2.0网页授权  72
5.5.1　OAuth2.0  72
5.5.2　授权过程  72
5.5.3　详细步骤  73
5.5.4　效果展示  79
5.6　生成带参数二维码  81
5.6.1　场景二维码  81
5.6.2　创建二维码ticket  81
5.6.3　通过ticket换取二维码  83
5.6.4　下载二维码  84
5.6.5　扫描带参数二维码事件  85
5.7　获取用户地理位置  87
5.7.1　获取用户地理位置  87
5.7.2　转换坐标到地址  88
5.7.3　用户地理位置的意义  90
5.8　获取用户基本信息  90
5.8.1　获取用户基本信息  91
5.8.2　制作个性欢迎语  92
5.9　获取关注者列表  93
5.9.1　获取关注者列表  93
5.9.2　分批获取  94
5.10　用户分组管理  96
5.10.1　创建分组  96
5.10.2　查询所有分组  97
5.10.3　查询用户所在分组  98
5.10.4　修改分组名  99
5.10.5　移动用户分组  100
5.11　上传下载多媒体文件  101
5.11.1　上传多媒体文件  101
5.11.2　下载多媒体文件  104
第6章　微信支付  109
6.1　申请微信支付  109
6.1.1　申请流程图  109
6.1.2　开放经营类目  112
6.1.3　资费标准  113
6.1.4　常见问题  114
6.2　微信支付功能介绍  114
6.2.1　方案简介  114
6.2.2　应用场景举例  115
6.2.3　商户模块  119
6.2.4　功能接口  120
6.2.5　账号体系  121
6.2.6　商户系统对接  122
6.2.7　行业案例  122
6.2.8　支付功能常见问题  124
6.3　微信支付接口  125
6.3.1　支付基础  125
6.3.2　JS API支付接口  132
6.3.3　Native(原生)支付接口  137
6.3.4　通知接口  140
6.3.5　收货地址共享接口  147
6.3.6　用户维权系统接口  149
第7章　生活类应用开发  151
7.1　天气预报  151
7.1.1　SmartWeatherAPI  151
7.1.2　区域编码表  156
7.1.3　开发实现  158
7.1.4　其他接口  162
7.2　快递查询  162
7.2.1　快递接口  163
7.2.2　开发实现  165
7.2.3　智能查询  169
7.3　中英翻译  171
7.3.1　有道翻译  171
7.3.2　开发实现  172
7.4　空气质量  173
7.4.1　PM25.in  173
7.4.2　开发实现  175
7.5　股票行情及分析  176
7.5.1　行情数据  176
7.5.2　个股分析  178
7.5.3　开发实现  178
7.6　苹果产品信息查询  184
7.6.1　过程分析  184
7.6.2　开发实现  188
7.7　历史上的今天  191
7.7.1　数据来源  191
7.7.2　开发实现  191
7.8　附近搜索  193
7.8.1　百度地图  193
7.8.2　开发实现  197
7.9　英语四六级查询  202
7.9.1　过程分析  202
7.9.2　开发实现  203
7.10　交通信息  205
7.10.1　第三方网站  205
7.10.2　开发实现  205
第8章　娱乐类应用开发  208
8.1　笑话  208
8.1.1　数据获取  208
8.1.2　开发实现  208
8.2　星座运势  210
8.2.1　新浪星座  210
8.2.2　开发实现  210
8.3　周公解梦  211
8.3.1　数据获取  212
8.3.2　开发实现  212
8.4　姓名测试  214
8.4.1　数据获取  214
8.4.2　代码实现  216
8.5　夫妻相  217
8.5.1　人脸识别  217
8.5.2　实现方案  219
8.5.3　代码实现  224
8.6　在线点歌  227
8.6.1　音乐掌门人  227
8.6.2　代码实现  229
8.7　一站到底  231
8.7.1　实现方案  231
8.7.2　代码实现  233
8.8　智能聊天机器人  238
8.8.1　iBotCloud  238
8.8.2　开发实现  240
第9章　企业类应用开发  242
9.1　会员卡  242
9.1.1　页面布局  242
9.1.2　后台实现  244
9.2　预约订单  247
9.2.1　页面布局  247
9.2.2　后台实现  250
9.3　产品相册  254
9.3.1　相册  254
9.3.2　画廊  259
9.4　大转盘  260
9.4.1　页面布局  261
9.4.2　后台实现  262
9.5　刮刮卡  266
9.5.1　页面布局  266
9.5.2　后台实现  268
9.6　地图导航  270
9.6.1　高德地图  270
9.6.2　开发实现  272
9.7　智能问答  273
9.7.1　关键词回复  273
9.7.2　中文分词  274
9.8　在线客服  277
9.8.1　流程状态  277
9.8.2　开发实现  278
9.9　广告效果统计  282
9.9.1　场景二维码  282
9.9.2　数据统计  284
第10章　微信开发实用技巧  289
10.1　表情飘落效果  289
10.2　QQ表情和Emoji表情  290
10.3　微信版本及手机系统  293
10.4　Weixin JS接口  295
10.5　发送给朋友与分享到朋友圈  297
10.6　Discuz微社区  299
附录A　关键词自动回复的规则  300
附录B　微信公众平台全局返回码说明  301
附录C　SAE分词词性说明  303
附录D　微信公众平台基础接口PHP SDK  305
附录E　微信公众平台自定义菜单及高级接口PHP SDK  312